<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VisionAI Object Detection - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap');

    :root {
      --primary-color: #6c63ff;
      --accent-color: #9f5fff;
      --bg-dark: #121212;
      --bg-light: #f0f0f0;
      --text-light: #ffffff;
      --text-dark: #111111;
      --shadow-glow-soft: 0 0 20px var(--accent-color);
    }
    [data-theme="dark"] {
      background-color: var(--bg-dark);
      color: var(--text-light);
    }
    [data-theme="light"] {
      background-color: var(--bg-light);
      color: var(--text-dark);
    }
    body {
      margin: 0;
      font-family: 'Orbitron', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      min-height: 100vh;
    }
    h1 {
      color: var(--primary-color);
      text-shadow: var(--shadow-glow-soft);
      text-align: center;
      margin-bottom: 1rem;
    }
    .container {
      max-width: 700px;
      width: 100%;
      background-color: var(--bg-dark);
      padding: 1rem;
      border-radius: 15px;
      box-shadow: var(--shadow-glow-soft);
    }
    [data-theme="light"] .container {
      background-color: var(--bg-light);
    }
    video, canvas {
      width: 100%;
      border-radius: 12px;
      box-shadow: var(--shadow-glow-soft);
      display: block;
      margin-bottom: 1rem;
    }
    .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    input, button {
      padding: 0.6rem 1rem;
      border-radius: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      margin: 5px;
    }
    button {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, background-color 0.3s;
    }
    button:hover {
      background-color: var(--accent-color);
      transform: scale(1.05);
    }
    #output {
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    footer {
      margin-top: auto;
      padding: 0.5rem;
      font-size: 0.8rem;
      color: #888;
    }
  </style>
</head>
<body data-theme="dark">
  <h1>VisionAI Object Detection - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ</h1>
  <div class="container">
    <!-- –í–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã -->
    <video id="webcam" autoplay muted playsinline></video>
    <!-- Canvas –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
    <canvas id="canvas"></canvas>

    <div class="controls">
      <input id="searchInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞">
      <button id="startSearchBtn">üîé –ò—Å–∫–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
      <button id="stopSearchBtn" disabled>‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫</button>
    </div>

    <div id="output">–ì–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É...</div>
  </div>

  <footer>¬© 2025 VisionAI KNN</footer>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º TensorFlow.js –∏ COCO-SSD –∏–∑ CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <!-- –ï—Å–ª–∏ –≤—Ç–æ—Ä–∞—è –º–æ–¥–µ–ª—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ tfjs –¥–æ—Å—Ç—É–ø–Ω–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –µ—ë —á–µ—Ä–µ–∑ tf.loadGraphModel -->

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let modelA, modelB;
    let isDetecting = false;
    
    /* –†–∞—Å—à–∏—Ä—ë–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å.
       –ö–ª—é—á ‚Äî –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –º–∞—Å—Å–∏–≤ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Ç–æ–∫,
       –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –º–æ–¥–µ–ª—å (–Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º). */
    const translationMap = {
      "—á–µ–ª–æ–≤–µ–∫": ["person", "man", "human"],
      "–±—É—Ç—ã–ª–∫–∞": ["bottle"],
      "—Å–æ–±–∞–∫–∞": ["dog"],
      "–∫–æ—à–∫–∞": ["cat"],
      // –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ –ø–∞—Ä—ã –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏...
    };

    // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const searchInput = document.getElementById('searchInput');
    const startSearchBtn = document.getElementById('startSearchBtn');
    const stopSearchBtn = document.getElementById('stopSearchBtn');
    const output = document.getElementById('output');

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
    function levenshtein(a, b) {
      const matrix = [];
      for (let i = 0; i <= b.length; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
      }
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          if (b.charAt(i - 1) === a.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1
            );
          }
        }
      }
      return matrix[b.length][a.length];
    }

    // –§—É–Ω–∫—Ü–∏—è –Ω–µ—á–µ—Ç–∫–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç true, –µ—Å–ª–∏ —Å—Ö–æ–∂–µ—Å—Ç—å (1 - distance/maxLen) –ø—Ä–µ–≤—ã—à–∞–µ—Ç threshold
    function fuzzyMatch(str1, str2, threshold = 0.5) {
      const distance = levenshtein(str1, str2);
      const maxLen = Math.max(str1.length, str2.length);
      const similarity = 1 - distance / maxLen;
      return similarity >= threshold;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É)
    async function setupCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        await new Promise(resolve => video.onloadedmetadata = resolve);
        video.play();
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
      } catch (err) {
        output.innerText = `–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ${err.message}`;
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π: —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∞ COCO-SSD (modelA), –∑–∞—Ç–µ–º –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ç–æ—Ä–æ–π –º–æ–¥–µ–ª–∏ (modelB).
    async function loadModels() {
      output.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ A (COCO-SSD)...";
      modelA = await cocoSsd.load();
      output.innerText = "–ú–æ–¥–µ–ª—å A –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ B...";
      try {
        // –ó–∞–º–µ–Ω–∏—Ç–µ 'path/to/your/model.json' –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL –≤—Ç–æ—Ä–æ–π –º–æ–¥–µ–ª–∏, –µ—Å–ª–∏ –æ–Ω–∞ –∏–º–µ–µ—Ç—Å—è.
        modelB = await tf.loadGraphModel('path/to/your/model.json');
        output.innerText = "–ú–æ–¥–µ–ª—å B –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–∏—Å–∫.";
      } catch (err) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å B. –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –º–æ–¥–µ–ª—å A.", err);
        modelB = null;
        output.innerText = "–ú–æ–¥–µ–ª—å B –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –º–æ–¥–µ–ª—å A. –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–∏—Å–∫.";
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–µ—Ç–µ–∫—Ü–∏–∏ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º —Å–ª–æ–≤–∞—Ä—ë–º –∏ –Ω–µ—á–µ—Ç–∫–∏–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º
    async function combinedDetect() {
      if (!isDetecting) return;
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ—Ç–µ–∫—Ü–∏–∏ –æ–±–µ–∏—Ö –º–æ–¥–µ–ª–µ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–µ—Å–ª–∏ modelB –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤)
      const [predictionsA, predictionsBArray] = await Promise.all([
        modelA.detect(video),
        modelB ? modelB.detect(video) : Promise.resolve([])
      ]);
      
      // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ—Ä–æ–≥—É score >= 0.3
      let allPredictions = predictionsA.concat(predictionsBArray).filter(pred => pred.score >= 0.3);
      
      // –ü–æ–ª—É—á–∞–µ–º –≤–≤–µ–¥—ë–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏ –ø—Ä–∏–≤–æ–¥–∏–º –µ–≥–æ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
      const query = searchInput.value.trim().toLowerCase();
      
      // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –µ—Å—Ç—å –∏ –æ–Ω –∏–º–µ–µ—Ç—Å—è –≤ —Å–ª–æ–≤–∞—Ä–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–∏—Å–æ–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
      // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –±—É–¥–µ–º —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é —Å –≤–≤–µ–¥—ë–Ω–Ω—ã–º
      const synonyms = translationMap[query] || [query];
      
      // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–µ—Ç–µ–∫—Ü–∏–∏: –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–∑ —Å–∏–Ω–æ–Ω–∏–º–æ–≤ fuzzyMatch —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –º–µ—Ç–∫–æ–π –¥–µ—Ç–µ–∫—Ü–∏–∏ (—Ç–∞–∫–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω–æ–π –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É)
      const finalResults = query ?
        allPredictions.filter(pred => 
          synonyms.some(syn => fuzzyMatch(syn, pred.class.toLowerCase(), 0.5))
        ) : allPredictions;
      
      // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä —Å –∫–∞–º–µ—Ä—ã –Ω–∞ canvas
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º bounding boxes –∏ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
      finalResults.forEach(pred => {
        const [x, y, width, height] = pred.bbox;
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'lime';
        ctx.font = '18px Arial';
        ctx.fillStyle = 'lime';
        ctx.strokeRect(x, y, width, height);
        ctx.fillText(`${pred.class} ${(pred.score * 100).toFixed(1)}%`, x, y > 20 ? y - 5 : y + 20);
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–ª–æ–∫–µ –≤—ã–≤–æ–¥–∞
      if (query === "") {
        output.innerText = "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞.";
      } else if (finalResults.length > 0) {
        output.innerText = `‚úÖ –ü—Ä–µ–¥–º–µ—Ç "${searchInput.value.trim()}" –Ω–∞–π–¥–µ–Ω!`;
      } else {
        output.innerText = `‚ùå –ü—Ä–µ–¥–º–µ—Ç "${searchInput.value.trim()}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`;
      }
      
      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–µ—Ç–µ–∫—Ü–∏—é –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
      requestAnimationFrame(combinedDetect);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å—Ç–∞—Ä—Ç–∞/—Å—Ç–æ–ø–∞ –ø–æ–∏—Å–∫–∞
    startSearchBtn.addEventListener('click', () => {
      if (!searchInput.value.trim()) {
        alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞!");
        return;
      }
      isDetecting = true;
      startSearchBtn.disabled = true;
      stopSearchBtn.disabled = false;
      combinedDetect();
    });

    stopSearchBtn.addEventListener('click', () => {
      isDetecting = false;
      startSearchBtn.disabled = false;
      stopSearchBtn.disabled = true;
      output.innerText = "–ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.";
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: —Å–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É, –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏
    setupCamera().then(loadModels);
  </script>
</body>
</html>
